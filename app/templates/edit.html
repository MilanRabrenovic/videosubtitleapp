<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Subtitles</title>
  <script src="/static/js/subtitles.js" defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .layout { display: grid; grid-template-columns: 1.6fr 1fr; gap: 24px; align-items: start; }
    .subtitle-block { border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; }
    .subtitle-row { display: flex; gap: 12px; margin-bottom: 8px; }
    .subtitle-row label { flex: 1; }
    textarea { width: 100%; min-height: 64px; }
    .actions { margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
    .status { margin-top: 8px; color: #2b6cb0; }
    .video-panel { position: sticky; top: 16px; }
    video { width: 100%; max-width: 480px; }
    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
      .video-panel { position: static; }
    }
  </style>
</head>
<body>
  <main>
    <h1>Edit Subtitles</h1>
    <p><strong>Job:</strong> {{ job.title }}</p>
    <p><strong>Video file:</strong> {{ job.video_filename }}</p>

    {% if saved %}
      <p class="status">Changes saved.</p>
    {% endif %}

    <div class="layout">
      <section>
        <form id="subtitle-form" action="/edit/{{ job.job_id }}" method="post">
          <input type="hidden" id="subtitles-json" name="subtitles_json" value="" />

          <fieldset>
            <legend>Subtitle styling</legend>
            <div class="subtitle-row">
              <label>
                Font
                <select name="style_font_family">
                  <option value="Arial" {% if job.style.font_family == "Arial" %}selected{% endif %}>Arial</option>
                  <option value="Helvetica" {% if job.style.font_family == "Helvetica" %}selected{% endif %}>Helvetica</option>
                  <option value="Verdana" {% if job.style.font_family == "Verdana" %}selected{% endif %}>Verdana</option>
                </select>
              </label>
              <label>
                Font size
                <input type="number" name="style_font_size" min="12" max="96" value="{{ job.style.font_size }}" />
              </label>
            </div>
            <div class="subtitle-row">
              <label>
                Text color
                <input type="color" name="style_text_color" value="{{ job.style.text_color }}" />
              </label>
              <label>
                Highlight color
                <input type="color" name="style_highlight_color" value="{{ job.style.highlight_color }}" />
              </label>
              <label>
                Outline color
                <input type="color" name="style_outline_color" value="{{ job.style.outline_color }}" />
              </label>
              <label>
                Outline
                <input type="checkbox" name="style_outline_enabled" {% if job.style.outline_enabled %}checked{% endif %} />
              </label>
              <label>
                Outline size
                <input type="number" name="style_outline_size" min="0" max="10" value="{{ job.style.outline_size }}" />
              </label>
            </div>
            <div class="subtitle-row">
              <label>
                Background box
                <input type="checkbox" name="style_background_enabled" {% if job.style.background_enabled %}checked{% endif %} />
              </label>
              <label>
                Background color
                <input type="color" name="style_background_color" value="{{ job.style.background_color }}" />
              </label>
              <label>
                Background opacity
                <input type="number" name="style_background_opacity" min="0" max="1" step="0.1" value="{{ job.style.background_opacity }}" />
              </label>
              <label>
                Background padding
                <input type="number" name="style_background_padding" min="0" max="40" value="{{ job.style.background_padding }}" />
              </label>
              <label>
                Background softness
                <input type="number" name="style_background_blur" min="0" max="10" step="0.5" value="{{ job.style.background_blur }}" />
              </label>
              <label>
                Line height
                <input type="number" name="style_line_height" min="0" max="200" step="1" value="{{ job.style.line_height }}" />
              </label>
            </div>
            <div class="subtitle-row">
              <label>
                Position
                <select name="style_position">
                  <option value="bottom" {% if job.style.position == "bottom" %}selected{% endif %}>Bottom</option>
                  <option value="center" {% if job.style.position == "center" %}selected{% endif %}>Center</option>
                  <option value="top" {% if job.style.position == "top" %}selected{% endif %}>Top</option>
                </select>
              </label>
              <label>
                Vertical margin
                <input type="number" name="style_margin_v" min="0" max="200" value="{{ job.style.margin_v }}" />
              </label>
            </div>
            <div class="subtitle-row">
              <label>
                Max words per line
                <input type="number" name="style_max_words_per_line" min="1" max="12" value="{{ job.style.max_words_per_line }}" />
              </label>
            </div>
          </fieldset>

          <div id="subtitle-list">
            {% for block in job.subtitles %}
              <div class="subtitle-block" data-index="{{ loop.index0 }}" data-group="{{ block.group_id }}">
                <div class="subtitle-row">
                  <label>
                    Start time
                    <input type="text" class="start" value="{{ block.start }}" />
                  </label>
                  <label>
                    End time
                    <input type="text" class="end" value="{{ block.end }}" />
                  </label>
                </div>
                <label>
                  Text
                  <textarea class="text">{{ block.text }}</textarea>
                </label>
              </div>
            {% endfor %}
          </div>

          <div class="actions">
            <button type="submit">Save edits</button>
            <span id="save-status" class="status" style="display: none;">Subtitles saved</span>
          </div>
          <p id="timestamp-hint" class="status" style="display: none;">
            One or more timestamps look invalid (expected HH:MM:SS,mmm)
          </p>
          <p id="edit-status" class="status"></p>
        </form>
      </section>
      <aside class="video-panel">
        <h2>Preview</h2>
        <video id="preview-video" controls>
          {% if preview_available %}
            <source src="/outputs/{{ job.job_id }}_preview.mp4" type="video/mp4" />
          {% else %}
            <source src="/uploads/{{ job.video_filename }}" type="video/mp4" />
          {% endif %}
          Your browser does not support the video tag.
        </video>
      </aside>
    </div>

    <div class="actions">
      <form action="/export/{{ job.job_id }}/subtitles" method="post">
        <input type="hidden" name="format" value="srt" />
        <button type="submit" data-export="srt">Download subtitles (SRT)</button>
      </form>
      <form action="/export/{{ job.job_id }}/subtitles" method="post">
        <input type="hidden" name="format" value="vtt" />
        <button type="submit">Download subtitles (VTT)</button>
      </form>
      <form action="/export/{{ job.job_id }}/video-karaoke" method="post">
        <button type="submit" data-export="video-karaoke">Export video with word highlight</button>
      </form>
    </div>
    <p id="export-status" class="status" style="display: none;"></p>
    <p id="video-export-status" class="status" style="display: none;"></p>
    <p id="karaoke-export-status" class="status" style="display: none;"></p>
    <p><em>Tip:</em> Save edits before exporting.</p>
  </main>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Subtitles</title>
  {% if font_css_url %}
    <link rel="stylesheet" href="{{ font_css_url }}" />
  {% endif %}
  <script src="/static/js/subtitles.js" defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .layout { display: grid; grid-template-columns: 1.6fr 1fr; gap: 24px; align-items: start; }
    .subtitle-block { border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; }
    .subtitle-row { display: flex; gap: 12px; margin-bottom: 8px; }
    .subtitle-row label { flex: 1; }
    textarea { width: 100%; min-height: 64px; }
    .actions { margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
    .status { margin-top: 8px; color: #2b6cb0; }
    .font-picker { position: relative; }
    .font-options {
      position: absolute;
      z-index: 10;
      background: #fff;
      border: 1px solid #ddd;
      max-height: 220px;
      overflow-y: auto;
      min-width: 220px;
      padding: 6px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }
    .font-group { font-size: 12px; color: #666; margin: 6px 6px 2px; }
    .font-option {
      display: block;
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      padding: 6px;
      cursor: pointer;
    }
    .font-option:hover { background: #f0f4ff; }
    .video-panel { position: sticky; top: 16px; }
    video { width: 100%; max-width: 480px; }
    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
      .video-panel { position: static; }
    }
  </style>
</head>
<body>
  <main>
    <h1>Edit Subtitles</h1>
    <p><strong>Job:</strong> {{ job.title }}</p>
    <p><strong>Video file:</strong> {{ job.video_filename }}</p>
    <form action="/jobs/{{ job.job_id }}/pin" method="post" class="actions" id="pin-form">
      <label>
        <input type="checkbox" name="pinned" id="pin-checkbox" {% if job_pinned %}checked{% endif %} />
        Pin this job (prevent cleanup)
      </label>
      <button type="button" id="pin-submit">Save</button>
      <span id="pin-status" class="status" style="display: none;">Pin saved</span>
    </form>

    {% if saved %}
      <p class="status">Changes saved.</p>
    {% endif %}
    {% if processing_job_id %}
      <p id="job-status" class="status" data-job-id="{{ processing_job_id }}">
        Processing videoâ€¦ this may take a minute.
      </p>
    {% elif processing_job_error %}
      <div id="job-status" class="status">
        <strong>Something went wrong</strong><br />
        {% if processing_job_step %}
          Failed during {{ processing_job_step }}.<br />
        {% endif %}
        {{ processing_job_error.message if processing_job_error.message else processing_job_error }}
        {% if processing_job_error.hint %}
          <br /><span>{{ processing_job_error.hint }}</span>
        {% endif %}
      </div>
    {% endif %}
    {% if font_warning %}
      <p class="status">{{ font_warning }}</p>
    {% endif %}
    <form action="/edit/{{ job.job_id }}/font-upload" method="post" enctype="multipart/form-data" class="actions">
      <label>
        Upload font (TTF/OTF)
        <input type="hidden" name="font_family" value="{{ job.style.font_family }}" />
        <input type="file" name="font_file" accept=".ttf,.otf" />
      </label>
      <label>
        <input type="checkbox" name="font_license_confirm" id="font-license-confirm" />
        I have the right to use this font
      </label>
      <button type="submit" id="font-upload-button" disabled>Upload font</button>
    </form>
    {% if custom_fonts %}
      <form action="/edit/{{ job.job_id }}/font-delete" method="post" class="actions">
        <input type="hidden" name="font_family" value="{{ job.style.font_family }}" />
        <button type="submit">Delete uploaded font</button>
      </form>
    {% endif %}

    <div class="layout">
      <section>
        <form id="subtitle-form" action="/edit/{{ job.job_id }}" method="post">
          <input type="hidden" id="subtitles-json" name="subtitles_json" value="" />

          <fieldset>
            <legend>Subtitle styling</legend>
            <div class="subtitle-row">
              <label>
                Font
                <div class="font-picker">
                  <input type="text" id="font-input" value="{{ job.style.font_family }}" autocomplete="off" />
                  <input type="hidden" id="font-value" name="style_font_family" value="{{ job.style.font_family }}" />
                  <div id="font-options" class="font-options" hidden>
                    <div class="font-group">System</div>
                    {% for font_name in system_fonts %}
                      <button type="button" class="font-option" data-value="{{ font_name }}">{{ font_name }}</button>
                    {% endfor %}
                    <div class="font-group">Google</div>
                    {% for font_name in google_fonts %}
                      <button type="button" class="font-option" data-value="{{ font_name }}">{{ font_name }}</button>
                    {% endfor %}
                    {% if custom_fonts %}
                      <div class="font-group">Custom (This Job)</div>
                      {% for font_name in custom_fonts %}
                        <button type="button" class="font-option" data-value="{{ font_name }}">{{ font_name }}</button>
                      {% endfor %}
                    {% endif %}
                  </div>
                </div>
              </label>
              <label>
                Font weight
                <select name="style_font_weight">
                  <option value="300" {% if job.style.font_weight == 300 %}selected{% endif %}>Light (300)</option>
                  <option value="400" {% if job.style.font_weight == 400 %}selected{% endif %}>Regular (400)</option>
                  <option value="500" {% if job.style.font_weight == 500 %}selected{% endif %}>Medium (500)</option>
                  <option value="600" {% if job.style.font_weight == 600 %}selected{% endif %}>SemiBold (600)</option>
                  <option value="700" {% if job.style.font_weight == 700 %}selected{% endif %}>Bold (700)</option>
                  <option value="800" {% if job.style.font_weight == 800 %}selected{% endif %}>ExtraBold (800)</option>
                  <option value="900" {% if job.style.font_weight == 900 %}selected{% endif %}>Black (900)</option>
                </select>
              </label>
              <label>
                Font style
                <select name="style_font_style">
                  <option value="regular" {% if job.style.font_style == "regular" %}selected{% endif %}>Regular</option>
                  <option value="italic" {% if job.style.font_style == "italic" %}selected{% endif %}>Italic</option>
                </select>
              </label>
              <label>
                Font size
                <input type="number" name="style_font_size" min="12" max="96" value="{{ job.style.font_size }}" />
              </label>
            </div>
            <div class="subtitle-row">
              <label>
                Text color
                <input type="color" name="style_text_color" value="{{ job.style.text_color }}" />
              </label>
              <label>
                Highlight color
                <input type="color" name="style_highlight_color" value="{{ job.style.highlight_color }}" />
              </label>
              <label>
                Outline color
                <input type="color" name="style_outline_color" value="{{ job.style.outline_color }}" />
              </label>
              <label>
                Outline
                <input type="checkbox" name="style_outline_enabled" {% if job.style.outline_enabled %}checked{% endif %} />
              </label>
              <label>
                Outline size
                <input type="number" name="style_outline_size" min="0" max="10" value="{{ job.style.outline_size }}" />
              </label>
            </div>
            <div class="subtitle-row">
              <label>
                Background box
                <input type="checkbox" name="style_background_enabled" {% if job.style.background_enabled %}checked{% endif %} />
              </label>
              <label>
                Background color
                <input type="color" name="style_background_color" value="{{ job.style.background_color }}" />
              </label>
              <label>
                Background opacity
                <input type="number" name="style_background_opacity" min="0" max="1" step="0.1" value="{{ job.style.background_opacity }}" />
              </label>
              <label>
                Background padding
                <input type="number" name="style_background_padding" min="0" max="40" value="{{ job.style.background_padding }}" />
              </label>
              <label>
                Background softness
                <input type="number" name="style_background_blur" min="0" max="10" step="0.5" value="{{ job.style.background_blur }}" />
              </label>
              <label>
                Subtitle line spacing
                <input type="number" name="style_line_height" min="0" max="200" step="1" value="{{ job.style.line_height }}" />
              </label>
            </div>
            <div class="subtitle-row">
              <label>
                Position
                <select name="style_position">
                  <option value="bottom" {% if job.style.position == "bottom" %}selected{% endif %}>Bottom</option>
                  <option value="center" {% if job.style.position == "center" %}selected{% endif %}>Center</option>
                  <option value="top" {% if job.style.position == "top" %}selected{% endif %}>Top</option>
                </select>
              </label>
              <label>
                Vertical margin
                <input type="number" name="style_margin_v" min="0" max="200" value="{{ job.style.margin_v }}" />
              </label>
            </div>
            <div class="subtitle-row">
              <label>
                Max words per line
                <input type="number" name="style_max_words_per_line" min="1" max="12" value="{{ job.style.max_words_per_line }}" />
              </label>
            </div>
          </fieldset>

          <div id="subtitle-list">
            {% for block in job.subtitles %}
              <div class="subtitle-block" data-index="{{ loop.index0 }}" data-group="{{ block.group_id }}">
                <div class="subtitle-row">
                  <label>
                    Start time
                    <input type="text" class="start" value="{{ block.start }}" />
                  </label>
                  <label>
                    End time
                    <input type="text" class="end" value="{{ block.end }}" />
                  </label>
                </div>
                <label>
                  Text
                  <textarea class="text">{{ block.text }}</textarea>
                </label>
              </div>
            {% endfor %}
          </div>

          <div class="actions">
            <button type="submit" id="save-button">Save edits</button>
            <span id="save-status" class="status" style="display: none;">Subtitles saved</span>
          </div>
          <p id="timestamp-hint" class="status" style="display: none;">
            One or more timestamps look invalid (expected HH:MM:SS,mmm)
          </p>
          <p id="edit-status" class="status"></p>
        </form>
      </section>
      <aside class="video-panel">
        <h2>Preview</h2>
        <video id="preview-video" controls>
          {% if preview_available %}
            <source src="/outputs/{{ job.job_id }}_preview.mp4{% if preview_token %}?v={{ preview_token }}{% endif %}" type="video/mp4" />
          {% else %}
            <source src="/uploads/{{ job.video_filename }}" type="video/mp4" />
          {% endif %}
          Your browser does not support the video tag.
        </video>
      </aside>
    </div>

    <div class="actions">
      <form action="/export/{{ job.job_id }}/subtitles" method="post">
        <input type="hidden" name="format" value="srt" />
        <button type="submit" data-export="srt">Download subtitles (SRT)</button>
      </form>
      <form action="/export/{{ job.job_id }}/subtitles" method="post">
        <input type="hidden" name="format" value="vtt" />
        <button type="submit">Download subtitles (VTT)</button>
      </form>
      <form action="/export/{{ job.job_id }}/video-karaoke" method="post">
        <button type="submit" data-export="video-karaoke">Export video with word highlight</button>
      </form>
    </div>
    <p id="export-status" class="status" style="display: none;"></p>
    <p id="video-export-status" class="status" style="display: none;"></p>
    <p id="karaoke-export-status" class="status" style="display: none;"></p>
    <p><em>Tip:</em> Save edits before exporting.</p>
    <span id="preview-job" data-job-id="{{ preview_job_id or '' }}" hidden></span>
    <span id="editor-job" data-job-id="{{ job.job_id }}" hidden></span>
  </main>
</body>
</html>

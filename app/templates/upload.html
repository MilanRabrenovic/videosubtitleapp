<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Video</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <div
    id="toast"
    class="pointer-events-none fixed bottom-6 left-1/2 z-50 hidden w-[calc(100%-2rem)] max-w-xl -translate-x-1/2 rounded-xl px-4 py-3 text-center text-sm font-medium shadow-xl"
    role="status"
    aria-live="polite"
  ></div>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ["Space Grotesk", "ui-sans-serif", "system-ui"],
          },
        },
      },
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900 font-display">
  <main class="mx-auto flex w-full max-w-6xl flex-col gap-10 px-6 py-12">
    <header class="space-y-3">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <p class="text-sm uppercase tracking-[0.3em] text-amber-600/80">Subtitle Studio</p>
        <form action="/logout" method="post">
          <button type="submit" class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">
            Log out
          </button>
        </form>
      </div>
      <h1 class="text-4xl font-semibold tracking-tight text-slate-900 md:text-5xl">Upload a video, fix the words, export fast.</h1>
      <p class="max-w-2xl text-lg text-slate-600">
        Generate subtitles with Whisper, edit them in plain text, and export burned-in captions without leaving the page.
      </p>
    </header>

    <div class="grid gap-8 lg:grid-cols-2">
      <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data" class="grid gap-6 md:grid-cols-2">
          <label class="block space-y-2 text-sm font-medium text-slate-700">
            Video title (optional)
            <input
              type="text"
              name="title"
              placeholder="Project name"
              class="w-full rounded-lg border border-slate-200 bg-white px-4 py-3 text-base text-slate-900 placeholder:text-slate-400 focus:border-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-200"
            />
          </label>
          <label class="block space-y-2 text-sm font-medium text-slate-700">
            Language
            <select
              name="language"
              class="w-full rounded-lg border border-slate-200 bg-white px-4 py-3 text-base text-slate-900 focus:border-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-200"
            >
              <option value="">Auto-detect</option>
              <option value="en">English</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="sk">Slovak</option>
              <option value="fi">Finnish</option>
            </select>
          </label>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-slate-700">Video file</label>
            <label
              id="drop-zone"
              class="mt-2 flex min-h-[180px] cursor-pointer flex-col items-center justify-center gap-3 rounded-2xl border border-dashed border-slate-300 bg-slate-50 px-6 py-6 text-center text-sm text-slate-600 transition hover:border-amber-300 hover:bg-amber-50"
            >
              <input
                id="video-input"
                type="file"
                name="video"
                accept="video/*"
                required
                class="sr-only"
              />
              <div class="flex h-12 w-12 items-center justify-center rounded-full bg-amber-100 text-amber-600">
                <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M7 16V8m0 0 5-5 5 5M7 8h10a4 4 0 014 4v4a4 4 0 01-4 4H7a4 4 0 01-4-4v-4a4 4 0 014-4z" />
                </svg>
              </div>
              <div class="space-y-1">
                <p class="text-base font-semibold text-slate-800">Drop your video here</p>
                <p class="text-sm text-slate-500">or click to browse</p>
              </div>
              <p id="file-name" class="max-w-full break-all text-xs text-slate-500"></p>
            </label>
          </div>
          <div class="flex flex-wrap items-center justify-center gap-4 md:col-span-2">
            <button
              id="upload-submit"
              type="submit"
              class="inline-flex w-full items-center justify-center rounded-lg bg-amber-400 px-8 py-3 text-sm font-semibold text-slate-900 transition hover:bg-amber-300 disabled:cursor-not-allowed disabled:opacity-60 md:w-auto"
            >
              Upload &amp; Generate Subtitles
            </button>
            <p id="upload-status" aria-live="polite" class="text-sm text-amber-700"></p>
          </div>
        </form>
      </section>

      {% if recent_jobs %}
        <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
          <h2 class="text-lg font-semibold text-slate-900">My recent projects</h2>
          <ul class="mt-4 space-y-3 text-sm text-slate-600">
            {% for job in recent_jobs %}
              <li class="rounded-xl border border-slate-200 bg-slate-50 p-4">
                <div class="flex flex-wrap items-start justify-between gap-3">
                  <div class="min-w-0 flex-1">
                    <div class="flex items-start justify-between gap-3">
                      <a
                        href="/edit/{{ job.job_id }}"
                        class="block max-w-full break-all text-base font-semibold text-amber-700 hover:text-amber-600"
                        title="{{ job.title }}"
                      >
                        {{ job.title }}
                      </a>
                      {% if job.pinned %}
                        <span class="shrink-0 rounded-full border border-amber-200 bg-amber-50 px-2 py-1 text-[10px] font-semibold uppercase tracking-wide text-amber-700">Kept 30d+</span>
                      {% endif %}
                    </div>
                    <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-500">
                      <span class="rounded-full border border-slate-200 px-2 py-1 uppercase tracking-wide">{{ job.status }}</span>
                      {% if job.last_accessed_at %}
                        <span>Last opened {{ job.last_accessed_at }}</span>
                      {% endif %}
                      <span class="text-slate-400">· {{ job.job_id_short }}</span>
                    </div>
                  </div>
                  <button
                    type="button"
                    class="delete-job rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-100"
                    data-job-id="{{ job.job_id }}"
                  >
                    Delete
                  </button>
                  <span class="delete-status text-xs text-amber-700"></span>
                </div>
              </li>
            {% endfor %}
          </ul>
        </section>
      {% endif %}
    </div>
  </main>
  <script>
    const form = document.getElementById("upload-form");
    const submit = document.getElementById("upload-submit");
    const status = document.getElementById("upload-status");
    const dropZone = document.getElementById("drop-zone");
    const fileInput = document.getElementById("video-input");
    const fileName = document.getElementById("file-name");
    const toast = document.getElementById("toast");
    const toastClasses = {
      info: "bg-slate-900/90 text-white border border-slate-700/60",
      success: "bg-emerald-50 text-emerald-900 border border-emerald-200",
      error: "bg-rose-50 text-rose-900 border border-rose-200",
      warning: "bg-amber-50 text-amber-900 border border-amber-200",
    };
    let toastTimer = null;
    const showToast = (message, type = "info", timeout = 2200) => {
      if (!toast) {
        return;
      }
      toast.className =
        "pointer-events-none fixed bottom-6 left-1/2 z-50 w-[calc(100%-2rem)] max-w-xl -translate-x-1/2 rounded-xl px-4 py-3 text-center text-sm font-medium shadow-xl";
      toast.classList.add(...toastClasses[type].split(" "));
      toast.textContent = message;
      toast.classList.remove("hidden");
      if (toastTimer) {
        clearTimeout(toastTimer);
      }
      if (timeout > 0) {
        toastTimer = setTimeout(() => {
          toast.classList.add("hidden");
        }, timeout);
      }
    };
    if (form && submit && status) {
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (submit.disabled) {
          return;
        }
        submit.disabled = true;
        status.textContent = "Transcribing video. This may take a minute...";
        showToast("Transcribing video. This may take a minute…", "info", 0);
        const formData = new FormData(form);
        try {
          const response = await fetch(form.action, { method: "POST", body: formData });
          if (response.ok) {
            window.location.href = response.url;
            return;
          }
          let detail = "Upload failed. Please try again.";
          try {
            const payload = await response.json();
            if (payload && payload.detail) {
              detail = payload.detail;
            }
          } catch (_) {
            // ignore parse errors
          }
          if (response.status === 413) {
            detail = "File is too large for this upload limit.";
          }
          if (response.status === 429) {
            detail = "Too many requests. Please wait a moment and try again.";
          }
          showToast(detail, response.status === 429 ? "warning" : "error", 3200);
          status.textContent = detail;
          submit.disabled = false;
        } catch (error) {
          showToast("Network error. Please try again.", "error", 3200);
          status.textContent = "Network error. Please try again.";
          submit.disabled = false;
        }
      });
    }
    if (fileInput && fileName) {
      fileInput.addEventListener("change", () => {
        const file = fileInput.files && fileInput.files[0];
        fileName.textContent = file ? file.name : "";
      });
    }
    if (dropZone && fileInput) {
      const activate = () => dropZone.classList.add("border-amber-400", "bg-amber-50");
      const deactivate = () => dropZone.classList.remove("border-amber-400", "bg-amber-50");
      dropZone.addEventListener("dragenter", (event) => {
        event.preventDefault();
        activate();
      });
      dropZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        activate();
      });
      dropZone.addEventListener("dragleave", () => {
        deactivate();
      });
      dropZone.addEventListener("drop", (event) => {
        event.preventDefault();
        deactivate();
        if (event.dataTransfer && event.dataTransfer.files.length) {
          const droppedFiles = event.dataTransfer.files;
          if (window.DataTransfer) {
            const transfer = new DataTransfer();
            transfer.items.add(droppedFiles[0]);
            fileInput.files = transfer.files;
          } else {
            fileInput.files = droppedFiles;
          }
          const file = droppedFiles[0];
          fileName.textContent = file ? file.name : "";
          fileInput.dispatchEvent(new Event("change", { bubbles: true }));
        }
      });
    }
    const deleteButtons = document.querySelectorAll(".delete-job");
    deleteButtons.forEach((button) => {
      const statusEl = button.parentElement && button.parentElement.querySelector(".delete-status");
      button.addEventListener("click", async () => {
        const jobId = button.dataset.jobId;
        if (!jobId) {
          return;
        }
        if (!window.confirm("Delete this project and its files?")) {
          return;
        }
        button.disabled = true;
        button.textContent = "Deleting...";
        if (statusEl) {
          statusEl.textContent = "";
        }
        try {
          const response = await fetch(`/jobs/${jobId}/delete`, { method: "POST" });
          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            const detail = payload && payload.detail ? payload.detail : "Delete failed";
            throw new Error(detail);
          }
          const card = button.closest("li");
          if (card) {
            card.remove();
          }
          showToast("Project deleted.", "success");
        } catch (error) {
          console.error(error);
          button.disabled = false;
          button.textContent = "Delete";
          if (statusEl) {
            statusEl.textContent = error.message || "Delete failed";
          }
          showToast(error.message || "Delete failed.", "error");
        }
      });
    });
  </script>
</body>
</html>
